<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Rent - –¢–µ—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #17212b;
            color: white;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #2c3e50;
            color: white;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        pre {
            background: #f8f9fa;
            color: #333;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .telegram-status {
            background: #17212b;
            border: 1px solid #3d5a80;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>üè† Social Rent - –¢–µ—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è</h1>
    
    <div id="telegram-status" class="telegram-status">
        <h3>üì± –°—Ç–∞—Ç—É—Å Telegram WebApp</h3>
        <div id="webAppStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="form-group">
        <h3>üîê –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h3>
        <button onclick="testAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é</button>
        <button onclick="loadProfile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        <div id="authResult"></div>
    </div>

    <div class="form-group">
        <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
        
        <div class="form-group">
            <label>–ò–º—è *</label>
            <input type="text" id="firstName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
        </div>
        
        <div class="form-group">
            <label>–§–∞–º–∏–ª–∏—è</label>
            <input type="text" id="lastName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é">
        </div>
        
        <div class="form-group">
            <label>–í–æ–∑—Ä–∞—Å—Ç *</label>
            <input type="number" id="age" min="18" max="100" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç">
        </div>
        
        <div class="form-group">
            <label>–û —Å–µ–±–µ</label>
            <textarea id="bio" rows="3" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."></textarea>
        </div>
        
        <div class="form-group">
            <label>–°—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ *</label>
            <select id="metroStation">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é –º–µ—Ç—Ä–æ</option>
                <option value="–°–æ–∫–æ–ª—å–Ω–∏–∫–∏">–°–æ–∫–æ–ª—å–Ω–∏–∫–∏</option>
                <option value="–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è">–ö—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∞—è</option>
                <option value="–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è">–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫–∞—è</option>
                <option value="–¢–≤–µ—Ä—Å–∫–∞—è">–¢–≤–µ—Ä—Å–∫–∞—è</option>
                <option value="–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è">–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è</option>
                <option value="–ê—Ä–±–∞—Ç—Å–∫–∞—è">–ê—Ä–±–∞—Ç—Å–∫–∞—è</option>
                <option value="–ö–∏–µ–≤—Å–∫–∞—è">–ö–∏–µ–≤—Å–∫–∞—è</option>
                <option value="–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç">–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</option>
                <option value="–í–î–ù–•">–í–î–ù–•</option>
                <option value="–ê–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è">–ê–ª–µ–∫—Å–µ–µ–≤—Å–∫–∞—è</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>–ë—é–¥–∂–µ—Ç –æ—Ç (‚ÇΩ/–º–µ—Å—è—Ü)</label>
            <input type="number" id="priceMin" min="0" placeholder="30000">
        </div>
        
        <div class="form-group">
            <label>–ë—é–¥–∂–µ—Ç –¥–æ (‚ÇΩ/–º–µ—Å—è—Ü)</label>
            <input type="number" id="priceMax" min="0" placeholder="60000">
        </div>
        
        <div class="form-group">
            <label>–†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: <span id="radiusValue">1000</span> –º</label>
            <input type="range" id="searchRadius" min="500" max="10000" step="500" value="1000" 
                   oninput="document.getElementById('radiusValue').textContent = this.value">
        </div>
        
        <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        <div id="profileResult"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8001';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Telegram WebApp
        function checkTelegramWebApp() {
            const webApp = window.Telegram?.WebApp;
            const statusDiv = document.getElementById('webAppStatus');
            
            if (webApp) {
                const user = webApp.initDataUnsafe?.user;
                const hasInitData = !!webApp.initData;
                
                statusDiv.innerHTML = `
                    <div><strong>WebApp:</strong> ‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω</div>
                    <div><strong>InitData:</strong> ${hasInitData ? '‚úÖ' : '‚ùå'} (${webApp.initData?.length || 0} —Å–∏–º–≤–æ–ª–æ–≤)</div>
                    <div><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${user ? '‚úÖ' : '‚ùå'}</div>
                    ${user ? `<div><strong>ID:</strong> ${user.id}</div>
                    <div><strong>–ò–º—è:</strong> ${user.first_name} ${user.last_name || ''}</div>
                    <div><strong>Username:</strong> @${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</div>` : ''}
                `;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ Telegram
                if (user) {
                    document.getElementById('firstName').value = user.first_name || '';
                    document.getElementById('lastName').value = user.last_name || '';
                }
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º WebApp
                webApp.ready();
                webApp.expand();
                
                return {
                    isAvailable: true,
                    hasInitData: hasInitData,
                    user: user,
                    initData: webApp.initData
                };
            } else {
                statusDiv.innerHTML = `
                    <div><strong>WebApp:</strong> ‚ùå –ù–µ –¥–æ—Å—Ç—É–ø–µ–Ω</div>
                    <div>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –º–æ–∫ –¥–∞–Ω–Ω—ã–º–∏</div>
                `;
                
                return {
                    isAvailable: false,
                    hasInitData: false,
                    user: null,
                    initData: null
                };
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function getAuthToken() {
            const webApp = window.Telegram?.WebApp;
            
            if (webApp?.initData) {
                console.log('Using Telegram initData for auth');
                return `Bearer ${webApp.initData}`;
            } else {
                console.log('Using mock data for auth');
                const mockData = {
                    id: 123456789,
                    first_name: 'Test',
                    last_name: 'User',
                    username: 'testuser'
                };
                return `Bearer ${JSON.stringify(mockData)}`;
            }
        }
        
        // –¢–µ—Å—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        async function testAuth() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/test-auth`, {
                    headers: {
                        'Authorization': getAuthToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        async function loadProfile() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<div class="info">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/me/secure`, {
                    headers: {
                        'Authorization': getAuthToken(),
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ñ–∏–ª—è
                    if (data.first_name) document.getElementById('firstName').value = data.first_name;
                    if (data.last_name) document.getElementById('lastName').value = data.last_name;
                    if (data.age) document.getElementById('age').value = data.age;
                    if (data.bio) document.getElementById('bio').value = data.bio;
                    if (data.metro_station) document.getElementById('metroStation').value = data.metro_station;
                    if (data.price_min) document.getElementById('priceMin').value = data.price_min;
                    if (data.price_max) document.getElementById('priceMax').value = data.price_max;
                    if (data.search_radius) {
                        document.getElementById('searchRadius').value = data.search_radius;
                        document.getElementById('radiusValue').textContent = data.search_radius;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        async function saveProfile() {
            const resultDiv = document.getElementById('profileResult');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            const firstName = document.getElementById('firstName').value.trim();
            const age = document.getElementById('age').value;
            const metroStation = document.getElementById('metroStation').value;
            
            if (!firstName) {
                resultDiv.innerHTML = '<div class="error">‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è</div>';
                return;
            }
            
            if (!age) {
                resultDiv.innerHTML = '<div class="error">‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç</div>';
                return;
            }
            
            if (!metroStation) {
                resultDiv.innerHTML = '<div class="error">‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–Ω—Ü–∏—é –º–µ—Ç—Ä–æ</div>';
                return;
            }
            
            const profileData = {
                first_name: firstName,
                last_name: document.getElementById('lastName').value.trim() || '',
                age: parseInt(age),
                bio: document.getElementById('bio').value.trim() || '',
                metro_station: metroStation,
                price_min: parseInt(document.getElementById('priceMin').value) || null,
                price_max: parseInt(document.getElementById('priceMax').value) || null,
                search_radius: parseInt(document.getElementById('searchRadius').value)
            };
            
            resultDiv.innerHTML = '<div class="info">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/profile/secure`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': getAuthToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
                    if (window.Telegram?.WebApp?.showAlert) {
                        window.Telegram.WebApp.showAlert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            checkTelegramWebApp();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                console.log('üì• –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è');
                loadProfile();
            }, 2000);
        });
    </script>
</body>
</html>